# Corepack, pnpm et la gestion des workspaces

## 1. La relation **Corepack ↔ pnpm**

- **Corepack** est inclus avec Node.js (v16.9+).  
  - Rôle : agir comme **gestionnaire de gestionnaires de paquets**.  
  - Il télécharge et exécute la version exacte de `npm`, `yarn` ou `pnpm` déclarée dans le projet.  

- Exemple dans `package.json` :
  ```json
  {
    "packageManager": "pnpm@9.10.0"
  }
  ```
  → Corepack s’assure que `pnpm 9.10.0` est utilisé, même si la machine n’a aucune installation globale de pnpm.

👉 **Avantages** :
- Cohérence entre développeurs et CI/CD.  
- Plus besoin d’installer pnpm globalement (`npm i -g pnpm`).  
- Version "figée" du package manager.

---

## 2. La gestion des **workspaces par pnpm**

Un **workspace** est un **monorepo** géré par `pnpm`.  
Il permet d’orchestrer plusieurs packages dans un seul dépôt.

### a) Déclaration
À la racine du projet, un fichier `pnpm-workspace.yaml` :
```yaml
packages:
  - "packages/*"
  - "apps/*"
```

### b) Installation
```bash
pnpm install
```
pnpm va :
- Installer toutes les dépendances.  
- Créer un **store unique** (`.pnpm-store`).  
- Générer des **symlinks** pour relier les dépendances internes (`@scope/libA` → `@scope/libB`).  

### c) Commandes utiles
- **Recursive** (tous les workspaces) :
  ```bash
  pnpm -r build
  ```
- **Filtrage** (un package spécifique) :
  ```bash
  pnpm -F @cdk/components test
  ```

### d) Résolution stricte
- Pas de **phantom dependencies** (impossible d’utiliser une lib non listée).  
- Le cache est **content-addressable** (chaque version unique n’existe qu’une fois).  
- Les `peerDependencies` sont respectées strictement.

### e) Avantages face à npm/yarn
- Performances (installations plus rapides).  
- Moins d’espace disque utilisé.  
- Dépendances mieux contrôlées.  

---

## 3. Exemple minimal de monorepo pnpm

```
monorepo/
│
├─ pnpm-workspace.yaml
├─ package.json
│
├─ packages/
│   ├─ utils/
│   │   └─ package.json
│   └─ app/
│       └─ package.json
```

```
📦 monorepo/
│
├─ pnpm-workspace.yaml
├─ packages/
│   ├─ components/
│   │   ├─ package.json   (dépend de react & @cdk/primitives)
│   │   └─ node_modules/
│   │       ├─ react  ────────────────┐
│   │       ├─ @cdk/primitives ───────┼─→ symlink vers ../primitives/
│   │       └─ .pnpm/
│   │           └─ react@18.2.0/ ─────┘
│   │
│   └─ primitives/
│       ├─ package.json
│       └─ node_modules/
│           └─ .pnpm/
│
└─ 📂 Global pnpm store (ex: C:\Users\<user>\AppData\Local\pnpm\store\v3)
    └─ react@18.2.0/
        └─ node_modules/react/   ← la "vraie" copie unique de React
```

### `pnpm-workspace.yaml`
```yaml
packages:
  - "packages/*"
```

### `packages/utils/package.json`
```json
{
  "name": "@example/utils",
  "version": "1.0.0",
  "main": "index.js"
}
```

### `packages/app/package.json`
```json
{
  "name": "@example/app",
  "version": "1.0.0",
  "main": "index.js",
  "dependencies": {
    "@example/utils": "workspace:*"
  }
}
```

→ Après `pnpm install`, `@example/app` utilisera `@example/utils` **via un symlink local** au lieu de télécharger depuis npm.

---

✅ **Résumé**  
- **Corepack** : garantit la version de `pnpm`.  
- **pnpm** : gère le workspace via `pnpm-workspace.yaml`, mutualise les dépendances et symlink les packages internes.  
