# Corepack, pnpm et la gestion des workspaces

## 1. La relation **Corepack â†” pnpm**

- **Corepack** est inclus avec Node.js (v16.9+).  
  - RÃ´le : agir comme **gestionnaire de gestionnaires de paquets**.  
  - Il tÃ©lÃ©charge et exÃ©cute la version exacte de `npm`, `yarn` ou `pnpm` dÃ©clarÃ©e dans le projet.  

- Exemple dans `package.json` :
  ```json
  {
    "packageManager": "pnpm@9.10.0"
  }
  ```
  â†’ Corepack sâ€™assure que `pnpm 9.10.0` est utilisÃ©, mÃªme si la machine nâ€™a aucune installation globale de pnpm.

ğŸ‘‰ **Avantages** :
- CohÃ©rence entre dÃ©veloppeurs et CI/CD.  
- Plus besoin dâ€™installer pnpm globalement (`npm i -g pnpm`).  
- Version "figÃ©e" du package manager.

---

## 2. La gestion des **workspaces par pnpm**

Un **workspace** est un **monorepo** gÃ©rÃ© par `pnpm`.  
Il permet dâ€™orchestrer plusieurs packages dans un seul dÃ©pÃ´t.

### a) DÃ©claration
Ã€ la racine du projet, un fichier `pnpm-workspace.yaml` :
```yaml
packages:
  - "packages/*"
  - "apps/*"
```

### b) Installation
```bash
pnpm install
```
pnpm va :
- Installer toutes les dÃ©pendances.  
- CrÃ©er un **store unique** (`.pnpm-store`).  
- GÃ©nÃ©rer des **symlinks** pour relier les dÃ©pendances internes (`@scope/libA` â†’ `@scope/libB`).  

### c) Commandes utiles
- **Recursive** (tous les workspaces) :
  ```bash
  pnpm -r build
  ```
- **Filtrage** (un package spÃ©cifique) :
  ```bash
  pnpm -F @cdk/components test
  ```

### d) RÃ©solution stricte
- Pas de **phantom dependencies** (impossible dâ€™utiliser une lib non listÃ©e).  
- Le cache est **content-addressable** (chaque version unique nâ€™existe quâ€™une fois).  
- Les `peerDependencies` sont respectÃ©es strictement.

### e) Avantages face Ã  npm/yarn
- Performances (installations plus rapides).  
- Moins dâ€™espace disque utilisÃ©.  
- DÃ©pendances mieux contrÃ´lÃ©es.  

---

## 3. Exemple minimal de monorepo pnpm

```
monorepo/
â”‚
â”œâ”€ pnpm-workspace.yaml
â”œâ”€ package.json
â”‚
â”œâ”€ packages/
â”‚   â”œâ”€ utils/
â”‚   â”‚   â””â”€ package.json
â”‚   â””â”€ app/
â”‚       â””â”€ package.json
```

```
ğŸ“¦ monorepo/
â”‚
â”œâ”€ pnpm-workspace.yaml
â”œâ”€ packages/
â”‚   â”œâ”€ components/
â”‚   â”‚   â”œâ”€ package.json   (dÃ©pend de react & @cdk/primitives)
â”‚   â”‚   â””â”€ node_modules/
â”‚   â”‚       â”œâ”€ react  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   â”‚       â”œâ”€ @cdk/primitives â”€â”€â”€â”€â”€â”€â”€â”¼â”€â†’ symlink vers ../primitives/
â”‚   â”‚       â””â”€ .pnpm/
â”‚   â”‚           â””â”€ react@18.2.0/ â”€â”€â”€â”€â”€â”˜
â”‚   â”‚
â”‚   â””â”€ primitives/
â”‚       â”œâ”€ package.json
â”‚       â””â”€ node_modules/
â”‚           â””â”€ .pnpm/
â”‚
â””â”€ ğŸ“‚ Global pnpm store (ex: C:\Users\<user>\AppData\Local\pnpm\store\v3)
    â””â”€ react@18.2.0/
        â””â”€ node_modules/react/   â† la "vraie" copie unique de React
```

### `pnpm-workspace.yaml`
```yaml
packages:
  - "packages/*"
```

### `packages/utils/package.json`
```json
{
  "name": "@example/utils",
  "version": "1.0.0",
  "main": "index.js"
}
```

### `packages/app/package.json`
```json
{
  "name": "@example/app",
  "version": "1.0.0",
  "main": "index.js",
  "dependencies": {
    "@example/utils": "workspace:*"
  }
}
```

â†’ AprÃ¨s `pnpm install`, `@example/app` utilisera `@example/utils` **via un symlink local** au lieu de tÃ©lÃ©charger depuis npm.

---

âœ… **RÃ©sumÃ©**  
- **Corepack** : garantit la version de `pnpm`.  
- **pnpm** : gÃ¨re le workspace via `pnpm-workspace.yaml`, mutualise les dÃ©pendances et symlink les packages internes.  
