# Gestion des versions avec `workspace:*` dans pnpm

## 1. Principe général

Lorsque vous déclarez une dépendance interne avec :

```json
{
  "dependencies": {
    "@cdk/primitives": "workspace:*"
  }
}
```

pnpm comprend qu’il doit utiliser **le package local du workspace**, au lieu d’aller chercher une version sur le registre npm.

---

## 2. Variantes de `workspace:` et comportements

| Déclaration                  | Effet                                                          | Cas d’usage recommandé |
|-------------------------------|---------------------------------------------------------------|-------------------------|
| `"workspace:*"`               | Lien direct vers la version locale, **sans vérification semver**. | Prototypage, développement rapide. |
| `"workspace:^"`               | Lien local, mais doit respecter la contrainte `^x.y.z`.       | Monorepo stable, aligné sur semver. |
| `"workspace:~"`               | Lien local, contrainte `~x.y.z`.                              | Cas où seuls patchs sont acceptés. |
| `"workspace:x.y.z"`           | Lien local, doit matcher **exactement** `x.y.z`.              | Dépendances verrouillées strictement. |
| `"workspace:*>1.0.0"`         | Lien local, contrainte avec un range semver complet.          | Projets complexes, contrôle fin. |

---

## 3. Exemple

### `packages/primitives/package.json`
```json
{
  "name": "@cdk/primitives",
  "version": "0.1.0"
}
```

### `packages/components/package.json`
```json
{
  "name": "@cdk/components",
  "version": "0.1.0",
  "dependencies": {
    "@cdk/primitives": "workspace:*"
  }
}
```

- **En développement** :  
  `@cdk/components` utilise un **symlink local** vers `packages/primitives`.

- **Au publish** :  
  La dépendance est automatiquement remplacée par la version effective :  

  ```json
  {
    "dependencies": {
      "@cdk/primitives": "0.1.0"
    }
  }
  ```

---

## 4. Bonnes pratiques

- Utilisez `workspace:*` si vous voulez **ignorer les contraintes de version** (rapide, mais risqué).  
- Préférez `workspace:^` ou `workspace:~` dans un **monorepo professionnel** : cela garde les bénéfices de semver tout en profitant des symlinks.  
- Avant un `publish`, assurez-vous que les **versions des packages internes sont cohérentes**.  

---

## 5. Bump de version avec pnpm

pnpm fournit une commande pour incrémenter les versions :  

```bash
pnpm version patch   # 0.1.0 -> 0.1.1
pnpm version minor   # 0.1.0 -> 0.2.0
pnpm version major   # 0.1.0 -> 1.0.0
```

### Exemple : bump d’un package interne

Si `@cdk/primitives` passe de `0.1.0` à `0.2.0` :

1. Dans `packages/primitives` :
   ```bash
   pnpm version minor
   ```
   → met à jour `"version": "0.2.0"` dans `package.json`.

2. Dans `packages/components`, la dépendance :
   ```json
   "@cdk/primitives": "workspace:*"
   ```
   restera valide (puisque `*` accepte tout).  
   → Lors du `publish`, pnpm remplacera par `"@cdk/primitives": "0.2.0"`.

3. Si vous aviez utilisé `workspace:^0.1.0`, alors pnpm signalera une incompatibilité car `0.2.0` ne respecte pas `^0.1.0`.

---

## 6. Résumé

- `workspace:` = toujours un lien interne dans le monorepo.  
- Au `publish`, pnpm remplace par la **vraie version**.  
- Utilisez `pnpm version [patch|minor|major]` pour incrémenter proprement les numéros de version.  
- Avec `workspace:^` ou `workspace:~`, pnpm aide à garder la compatibilité semver entre les packages internes.
